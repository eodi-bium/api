name: Deploy to EC2 (Spring Boot + Docker)

on:
  push:
    branches:
      - develop
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/inha-capstone-server
  CONTAINER_NAME: inha-capstone-server

jobs:
  # =========================================================
  # JOB 1: 빌드 및 도커 이미지 푸시
  # =========================================================
  build:
    name: Build & Push
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 17 설정
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: application-prod.yml 생성
        run: |
          mkdir -p modules/app/src/main/resources
          echo "${{ secrets.APPLICATION_PROD_YML }}" > modules/app/src/main/resources/application-prod.yml

      - name: Docker Hub 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker 이미지 빌드 및 푸시
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:latest

  # =========================================================
  # JOB 2: EC2 배포
  # =========================================================
  deploy:
    name: Deploy to EC2
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: EC2 접속 및 배포
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          debug: true
          script: |
            # 1. 도커 로그인
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            # 2. 최신 이미지 받기
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # 3. 기존 컨테이너 중지 및 삭제 (에러 무시)
            docker stop ${{ env.CONTAINER_NAME }} || true
            docker rm ${{ env.CONTAINER_NAME }} || true
            
            # 4. 불필요한 이미지 정리
            docker image prune -f
            
            # 5. 새 컨테이너 실행 (환경변수 주입 필요시 -e 옵션 추가)
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              -p 8080:8080 \
              ${{ env.DOCKER_IMAGE }}:latest